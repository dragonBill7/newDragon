<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ‰“åœ°é¼ éŠæˆ² - dragonBill7</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --panel: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.16);
      --good: #22c55e;
      --good-dark: #15803d;
      --bad: #f97373;
      --bad-dark: #b91c1c;
      --text-subtle: #9ca3af;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      touch-action: manipulation;
      min-height: 100vh;
      overscroll-behavior: none;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background:
        radial-gradient(circle at top left, #1e293b 0, transparent 55%),
        radial-gradient(circle at bottom right, #0f172a 0, transparent 55%),
        var(--bg);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    #app {
      width: 100%;
      max-width: 480px;
      background: linear-gradient(145deg, #020617, #020617);
      border-radius: 20px;
      box-shadow:
        0 24px 60px rgba(15,23,42,0.9),
        0 0 0 1px rgba(148,163,184,0.16);
      padding: 18px 16px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    #titleBlock {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #logo {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 20%, #38bdf8, #0f172a);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 0 0 1px rgba(148,163,184,0.3);
    }

    h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.04em;
    }

    #subtitle {
      margin: 0;
      font-size: 11px;
      color: var(--text-subtle);
    }

    #musicToggle {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 11px;
      padding: 4px 10px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    #musicToggle span.icon {
      font-size: 13px;
    }

    #panel {
      margin-top: 4px;
      background: radial-gradient(circle at top, rgba(56,189,248,0.14), transparent 55%),
                  rgba(15,23,42,0.96);
      border-radius: 16px;
      padding: 12px 10px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: inset 0 0 0 1px rgba(15,23,42,0.9);
    }

    #infoBar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 13px;
    }

    #score {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 2px 6px rgba(15,23,42,0.8);
    }

    #hint {
      font-size: 11px;
      color: var(--text-subtle);
      text-align: right;
    }

    #gridWrapper {
      padding: 10px 6px 4px;
      border-radius: 14px;
      background: radial-gradient(circle at top, #020617, #020617);
      box-shadow: inset 0 0 0 1px rgba(30,64,175,0.5);
    }

    #grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      width: 100%;
      max-width: 360px;
      margin: 0 auto;
    }

    .hole {
      aspect-ratio: 1 / 1;
      border-radius: 18px;
      background: radial-gradient(circle at 30% 20%, #1f2937, #020617 70%);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: transform 0.08s ease-out, box-shadow 0.08s, background 0.12s;
      box-shadow: 0 6px 14px rgba(15,23,42,0.9);
    }

    .hole:active {
      transform: translateY(1px) scale(0.97);
      box-shadow: 0 3px 8px rgba(15,23,42,0.95);
    }

    .hole.revealed-good {
      background: radial-gradient(circle at 30% 20%, rgba(34,197,94,0.9), #022c22 70%);
    }

    .hole.revealed-bad {
      background: radial-gradient(circle at 30% 20%, rgba(239,68,68,0.9), #450a0a 70%);
    }

    .mole {
      width: 70%;
      height: 70%;
      border-radius: 999px;
      background: rgba(15,23,42,0.96);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(26px, 5vw, 34px);
      box-shadow: 0 4px 0 rgba(15,23,42,1);
      transform: translateY(6%);
      transition: transform 0.12s ease-out, background 0.12s, box-shadow 0.12s;
    }

    .mole.revealed.good {
      background: #bbf7d0;
      box-shadow: 0 4px 0 #16a34a;
      transform: translateY(0);
    }

    .mole.revealed.bad {
      background: #fecaca;
      box-shadow: 0 4px 0 #b91c1c;
      transform: translateY(0);
    }

    .mole span {
      pointer-events: none;
    }

    #controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    #restartBtn {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border: none;
      color: #ecfdf5;
      padding: 7px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 13px;
      letter-spacing: 0.03em;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 8px 18px rgba(22,163,74,0.65);
    }

    #restartBtn:hover {
      filter: brightness(1.03);
    }

    #statusBadge {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.85);
      color: var(--text-subtle);
    }

    #message {
      min-height: 1.6em;
      font-size: 13px;
      text-align: center;
      margin-top: 6px;
    }

    #punishmentsBox {
      margin-top: 10px;
      width: 100%;
      font-size: 12px;
      color: var(--text-subtle);
      border-top: 1px dashed rgba(55,65,81,0.9);
      padding-top: 8px;
    }

    #punishmentsBox label {
      display: block;
      margin-bottom: 4px;
    }

    #punishmentsInput {
      width: 100%;
      min-height: 70px;
      margin-top: 4px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      padding: 6px 8px;
      font-size: 12px;
      resize: vertical;
      font-family: inherit;
    }

    #punishmentsBox small {
      display: block;
      margin-top: 4px;
      font-size: 11px;
    }

    @media (max-width: 480px) {
      #app {
        padding: 14px 12px 12px;
        border-radius: 18px;
      }
      #gridWrapper {
        padding: 12px 6px 6px;
      }
      #grid {
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div id="titleBlock">
        <div id="logo">ğŸ¦¦</div>
        <div>
          <h1>æ‰“åœ°é¼ ãƒ»è™•ç½°å±€</h1>
          <p id="subtitle">9 éš»åœ°é¼ éš¨æ©Ÿè— 3 éš»å£åœ°é¼ ï¼ŒæŒ‰ä¸‹å»æ‰çŸ¥é“çµæœã€‚</p>
        </div>
      </div>
      <button id="musicToggle" type="button">
        <span class="icon">ğŸ”ˆ</span>
        <span class="label">éŸ³æ¨‚é—œ</span>
      </button>
    </header>

    <section id="panel">
      <div id="infoBar">
        <div id="score">å·²æ‰¾åˆ°å£åœ°é¼ ï¼š0 / 3</div>
        <div id="hint">é»ä»»æ„åœ°é¼ ï¼Œç¿»é–‹çœ‹å¥½å£ã€‚</div>
      </div>

      <div id="gridWrapper">
        <div id="grid"></div>
      </div>

      <div id="controls">
        <button id="restartBtn" type="button">
          <span>ğŸ”„</span>
          <span>é‡æ–°æ´—ç‰Œé–‹å§‹</span>
        </button>
        <div id="statusBadge">é€²è¡Œä¸­</div>
      </div>

      <div id="message"></div>

      <div id="punishmentsBox">
        <label for="punishmentsInput">ç›®å‰çš„è™•ç½°æ¸…å–®ï¼ˆå¯è‡ªè¡Œä¿®æ”¹ï¼Œæ¯è¡Œä¸€å€‹ï¼‰ï¼š</label>
        <textarea id="punishmentsInput"></textarea>
        <small>é è¨­æˆ‘å¹«ä½ æº–å‚™å¹¾å€‹ï¼›ä½ å¯ä»¥æ”¹æˆè‡ªå·±çš„ï¼Œä¾‹å¦‚ã€Œè«‹å¤§å®¶å–é£²æ–™ã€ã€ã€Œæ·±è¹² 20 ä¸‹ã€ç­‰ç­‰ã€‚éŠæˆ²æœƒå¾ä¸Šé¢çš„æ¸…å–®éš¨æ©ŸæŠ½ä¸€å€‹ã€‚</small>
      </div>
    </section>
  </div>

  <!-- èƒŒæ™¯éŸ³æ¨‚ï¼ˆå¯åˆ‡æ›ï¼‰-->
  <audio id="bgm" loop preload="auto" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_7f546a4df0.mp3?filename=lofi-study-112191.mp3"></audio>

  <script>
    const gridEl = document.getElementById('grid');
    const scoreEl = document.getElementById('score');
    const messageEl = document.getElementById('message');
    const restartBtn = document.getElementById('restartBtn');
    const punishmentsInput = document.getElementById('punishmentsInput');
    const statusBadge = document.getElementById('statusBadge');
    const musicToggle = document.getElementById('musicToggle');
    const musicIcon = musicToggle.querySelector('.icon');
    const musicLabel = musicToggle.querySelector('.label');
    const bgm = document.getElementById('bgm');

    const LS_KEY = 'wam_punishments_v1';

    const defaultPunishments = [
      'è«‹å¤§å®¶å–ä¸€æ¯é£²æ–™',
      'æ·±è¹² 20 ä¸‹',
      'æ¨¡ä»¿ä¸€ç¨®å‹•ç‰©å«è² 10 ç§’',
      'ç•¶å ´å”±ä¸€å°æ®µæ­Œ',
      'ä»Šå¤©çš„åƒåœ¾ä½ åŒ…è¾¦',
      'è®“æ—é‚Šçš„äººæŒ‡å®šä¸€å€‹å°æ‡²ç½°ï¼ˆå‹å–„ç‰ˆï¼‰'
    ];

    // å¾ localStorage è¼‰å…¥è‡ªè¨‚è™•ç½°æ¸…å–®ï¼ˆå¦‚æœæœ‰ï¼‰
    try {
      const saved = localStorage.getItem(LS_KEY);
      if (saved) {
        punishmentsInput.value = JSON.parse(saved).join('\n');
      } else {
        punishmentsInput.value = defaultPunishments.join('\n');
      }
    } catch (e) {
      punishmentsInput.value = defaultPunishments.join('\n');
    }

    const totalHoles = 9;
    const badCountTotal = 3;
    let holes = [];
    let badRevealed = 0;
    let gameOver = false;

    let audioCtx = null;

    function ensureAudioCtx() {
      if (!audioCtx) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (AudioContext) {
          audioCtx = new AudioContext();
        }
      }
    }

    function playBeep(freq, duration = 0.12, type = 'sine', gainValue = 0.25) {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type;
      osc.frequency.value = freq;
      gain.gain.value = gainValue;
      osc.connect(gain).connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      osc.start(now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
      osc.stop(now + duration + 0.02);
    }

    function playGoodHitSound() {
      ensureAudioCtx();
      if (!audioCtx) return;
      playBeep(720, 0.09, 'sine', 0.25);
    }

    function playBadHitSound() {
      ensureAudioCtx();
      if (!audioCtx) return;
      playBeep(220, 0.16, 'sawtooth', 0.23);
      setTimeout(() => playBeep(180, 0.18, 'square', 0.18), 90);
    }

    function toggleMusic() {
      if (!bgm) return;
      ensureAudioCtx();
      if (audioCtx && audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
      if (bgm.paused) {
        bgm.volume = 0.4;
        if (bgm.currentTime === 0) {
          bgm.currentTime = 0.01; // iOS æœ‰æ™‚éœ€è¦ç•¥é 0 ç§’é¿å…éœéŸ³ bug
        }
        bgm.play().catch(() => {});
        musicIcon.textContent = 'ğŸµ';
        musicLabel.textContent = 'éŸ³æ¨‚é–‹';
      } else {
        bgm.pause();
        musicIcon.textContent = 'ğŸ”ˆ';
        musicLabel.textContent = 'éŸ³æ¨‚é—œ';
      }
    }

    musicToggle.addEventListener('click', toggleMusic);

    const punishmentsBox = document.getElementById('punishmentsBox');

    function createGrid() {
      gridEl.innerHTML = '';
      holes = [];
      for (let i = 0; i < totalHoles; i++) {
        const hole = document.createElement('div');
        hole.className = 'hole';
        hole.dataset.index = i;

        const mole = document.createElement('div');
        mole.className = 'mole';
        const span = document.createElement('span');
        span.textContent = 'â“';
        mole.appendChild(span);

        hole.appendChild(mole);
        gridEl.appendChild(hole);

        holes.push({
          hole,
          mole,
          type: 'good',
          revealed: false
        });

        hole.addEventListener('click', () => handleHit(i));
      }
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function setupMoles() {
      badRevealed = 0;
      gameOver = false;
      scoreEl.textContent = `å·²æ‰¾åˆ°å£åœ°é¼ ï¼š${badRevealed} / ${badCountTotal}`;
      messageEl.textContent = 'é»ä»»æ„åœ°é¼ ï¼Œçœ‹çœ‹æ˜¯å¥½æ˜¯å£ã€‚';
      statusBadge.textContent = 'é€²è¡Œä¸­';

      const indices = [...Array(totalHoles).keys()];
      shuffle(indices);
      const badSet = new Set(indices.slice(0, badCountTotal));

      holes.forEach((slot, i) => {
        slot.type = badSet.has(i) ? 'bad' : 'good';
        slot.revealed = false;
        slot.mole.classList.remove('revealed', 'good', 'bad');
        slot.hole.classList.remove('revealed-good', 'revealed-bad');
        slot.mole.querySelector('span').textContent = 'â“';
      });
    }

    function getPunishments() {
      const lines = punishmentsInput.value
        .split(/\r?\n/)
        .map(s => s.trim())
        .filter(Boolean);
      return lines.length ? lines : defaultPunishments;
    }

    // å³æ™‚æŠŠè™•ç½°æ¸…å–®å­˜åˆ° localStorageï¼Œé¿å…é‡æ•´å¾Œæ¶ˆå¤±
    punishmentsInput.addEventListener('input', () => {
      const lines = punishmentsInput.value
        .split(/\r?\n/)
        .map(s => s.trim())
        .filter(Boolean);
      try {
        localStorage.setItem(LS_KEY, JSON.stringify(lines));
      } catch (e) {
        // å¦‚æœä½¿ç”¨è€…é—œé–‰ storage æˆ–ç©ºé–“ä¸è¶³ï¼Œå°±å®‰éœå¤±æ•—å³å¯
      }
    });


    function randomPunishment() {
      const list = getPunishments();
      const idx = Math.floor(Math.random() * list.length);
      return list[idx];
    }

    function handleHit(index) {
      if (gameOver) return;
      const slot = holes[index];
      if (slot.revealed) return;

      ensureAudioCtx();

      slot.revealed = true;
      const mole = slot.mole;
      const span = mole.querySelector('span');
      mole.classList.add('revealed');

      if (slot.type === 'good') {
        mole.classList.add('good');
        slot.hole.classList.add('revealed-good');
        span.textContent = 'ğŸ¹';
        messageEl.textContent = 'ğŸ‘ é€™éš»æ˜¯å¥½åœ°é¼ ï¼Œå®‰å…¨ï½';
        playGoodHitSound();
      } else {
        mole.classList.add('bad');
        slot.hole.classList.add('revealed-bad');
        span.textContent = 'ğŸ’£';
        badRevealed++;
        const p = randomPunishment();
        messageEl.textContent = 'âš ï¸ å£åœ°é¼ ï¼è™•ç½°ï¼š' + p;
        scoreEl.textContent = `å·²æ‰¾åˆ°å£åœ°é¼ ï¼š${badRevealed} / ${badCountTotal}`;
        playBadHitSound();

        if (badRevealed >= badCountTotal) {
          gameOver = true;
          statusBadge.textContent = 'æœ¬å±€çµæŸ';
          messageEl.textContent += ' ï½œ 3 éš»å£åœ°é¼ éƒ½è¢«æ‰¾åˆ°ï¼ŒéŠæˆ²çµæŸã€‚';
        }
      }
    }

    restartBtn.addEventListener('click', () => {
      setupMoles();
      // ç¬¬ä¸€å€‹äº’å‹•æ™‚è©¦è‘—é–‹å•ŸéŸ³æ¨‚ï¼ˆè‹¥ä½¿ç”¨è€…æœ‰é–‹å•Ÿï¼‰
      if (!bgm.paused) {
        toggleMusic();
        toggleMusic();
      }
    });

    // ç¦ç”¨æ‰‹æ©Ÿé›™æ“Šæ”¾å¤§
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, { passive: false });

    createGrid();
    setupMoles();
  </script>
</body>
</html>
